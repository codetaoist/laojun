name: CD Pipeline

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to deploy (leave empty for latest)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ç¡®å®šéƒ¨ç½²ç‰ˆæœ¬
  determine-version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.version }}" != "" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

  # é¢„éƒ¨ç½²æ£€æŸ¥
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    needs: determine-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify images exist
        run: |
          docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/laojun-discovery:${{ needs.determine-version.outputs.version }}
          docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/laojun-monitoring:${{ needs.determine-version.outputs.version }}

      - name: Run security scan on deployment images
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/laojun-discovery:${{ needs.determine-version.outputs.version }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [determine-version, pre-deployment-checks]
    if: needs.determine-version.outputs.environment == 'production'
    environment:
      name: production
      url: https://taishanglaojun.local
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.PRODUCTION_KUBECONFIG }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Create backup
        run: |
          # å¤‡ä»½å½“å‰éƒ¨ç½²
          kubectl get all -n taishanglaojun -o yaml > backup-$(date +%Y%m%d-%H%M%S).yaml
          
          # å¤‡ä»½ Helm release
          helm get values taishanglaojun -n taishanglaojun > values-backup-$(date +%Y%m%d-%H%M%S).yaml

      - name: Deploy to production
        run: |
          helm upgrade --install taishanglaojun ./helm/taishanglaojun \
            --namespace taishanglaojun \
            --create-namespace \
            --set global.imageRegistry=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set global.domain=taishanglaojun.local \
            --set platform.discovery.image.tag=${{ needs.determine-version.outputs.version }} \
            --set platform.monitoring.image.tag=${{ needs.determine-version.outputs.version }} \
            --set platform.discovery.replicaCount=3 \
            --set platform.monitoring.replicaCount=3 \
            --set monitoring.prometheus.persistence.size=100Gi \
            --set monitoring.grafana.persistence.size=20Gi \
            --wait --timeout=15m

      - name: Verify deployment
        run: |
          # ç­‰å¾…æ‰€æœ‰ Pod å°±ç»ª
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=taishanglaojun -n taishanglaojun --timeout=600s
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=taishanglaojun-monitoring -n taishanglaojun-monitoring --timeout=600s
          
          # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
          kubectl get pods -n taishanglaojun
          kubectl get pods -n taishanglaojun-monitoring
          
          # è¿è¡Œå¥åº·æ£€æŸ¥
          curl -f http://taishanglaojun.local/health || exit 1
          curl -f http://api.taishanglaojun.local/discovery/health || exit 1
          curl -f http://api.taishanglaojun.local/monitoring/health || exit 1

      - name: Run post-deployment tests
        run: |
          cd tests/e2e
          go test -v -tags=e2e ./... -env=production

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: production-deployment-${{ needs.determine-version.outputs.version }}
          path: |
            backup-*.yaml
            values-backup-*.yaml

  # éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [determine-version, pre-deployment-checks]
    if: needs.determine-version.outputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.taishanglaojun.local
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.STAGING_KUBECONFIG }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Deploy to staging
        run: |
          helm upgrade --install taishanglaojun-staging ./helm/taishanglaojun \
            --namespace taishanglaojun-staging \
            --create-namespace \
            --set global.imageRegistry=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set global.domain=staging.taishanglaojun.local \
            --set platform.discovery.image.tag=${{ needs.determine-version.outputs.version }} \
            --set platform.monitoring.image.tag=${{ needs.determine-version.outputs.version }} \
            --wait --timeout=10m

      - name: Verify staging deployment
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=taishanglaojun -n taishanglaojun-staging --timeout=300s
          curl -f http://staging.taishanglaojun.local/health || exit 1

  # é‡‘ä¸é›€éƒ¨ç½² (ä»…ç”Ÿäº§ç¯å¢ƒ)
  canary-deployment:
    name: Canary Deployment
    runs-on: ubuntu-latest
    needs: [determine-version, pre-deployment-checks]
    if: needs.determine-version.outputs.environment == 'production' && github.ref_type == 'tag'
    environment:
      name: production-canary
      url: https://canary.taishanglaojun.local
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.PRODUCTION_KUBECONFIG }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Deploy canary version
        run: |
          # éƒ¨ç½²é‡‘ä¸é›€ç‰ˆæœ¬ (10% æµé‡)
          helm upgrade --install taishanglaojun-canary ./helm/taishanglaojun \
            --namespace taishanglaojun-canary \
            --create-namespace \
            --set global.imageRegistry=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set global.domain=canary.taishanglaojun.local \
            --set platform.discovery.image.tag=${{ needs.determine-version.outputs.version }} \
            --set platform.monitoring.image.tag=${{ needs.determine-version.outputs.version }} \
            --set platform.discovery.replicaCount=1 \
            --set platform.monitoring.replicaCount=1 \
            --wait --timeout=10m

      - name: Configure traffic splitting
        run: |
          # é…ç½® Istio æˆ– NGINX è¿›è¡Œæµé‡åˆ†å‰²
          kubectl apply -f k8s/canary/traffic-split.yaml

      - name: Monitor canary metrics
        run: |
          # ç›‘æ§é‡‘ä¸é›€ç‰ˆæœ¬çš„æŒ‡æ ‡
          sleep 300  # ç­‰å¾… 5 åˆ†é’Ÿæ”¶é›†æŒ‡æ ‡
          
          # æ£€æŸ¥é”™è¯¯ç‡å’Œå“åº”æ—¶é—´
          ERROR_RATE=$(curl -s "http://prometheus.taishanglaojun.local/api/v1/query?query=rate(http_requests_total{status=~'5..'}[5m])" | jq -r '.data.result[0].value[1]')
          
          if (( $(echo "$ERROR_RATE > 0.01" | bc -l) )); then
            echo "Error rate too high: $ERROR_RATE"
            exit 1
          fi

      - name: Promote or rollback canary
        run: |
          # å¦‚æœæŒ‡æ ‡æ­£å¸¸ï¼Œæå‡é‡‘ä¸é›€ç‰ˆæœ¬
          # å¦åˆ™å›æ»š
          echo "Canary deployment successful, ready for full rollout"

  # æ•°æ®åº“è¿ç§»
  database-migration:
    name: Database Migration
    runs-on: ubuntu-latest
    needs: [determine-version]
    if: needs.determine-version.outputs.environment == 'production'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run database migrations
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          cd migrations
          go run migrate.go up

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: needs.determine-version.outputs.environment == 'production'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run performance benchmark
        run: |
          cd tests/performance
          k6 run --out json=production-benchmark.json production-benchmark.js

      - name: Compare with baseline
        run: |
          cd tests/performance
          python3 compare-benchmark.py production-benchmark.json baseline.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: performance-benchmark-${{ needs.determine-version.outputs.version }}
          path: tests/performance/production-benchmark.json

  # ç›‘æ§å’Œå‘Šè­¦é…ç½®
  configure-monitoring:
    name: Configure Monitoring
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging]
    if: always() && (needs.deploy-production.result == 'success' || needs.deploy-staging.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.PRODUCTION_KUBECONFIG }}

      - name: Update Prometheus rules
        run: |
          kubectl apply -f monitoring/prometheus/rules/ -n taishanglaojun-monitoring

      - name: Update Grafana dashboards
        run: |
          kubectl create configmap grafana-dashboards \
            --from-file=monitoring/grafana/dashboards/ \
            -n taishanglaojun-monitoring \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Configure alerts
        run: |
          kubectl apply -f monitoring/alertmanager/ -n taishanglaojun-monitoring

  # æ¸…ç†æ—§ç‰ˆæœ¬
  cleanup:
    name: Cleanup Old Versions
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging]
    if: always() && (needs.deploy-production.result == 'success' || needs.deploy-staging.result == 'success')
    steps:
      - name: Cleanup old Docker images
        run: |
          # ä¿ç•™æœ€è¿‘ 10 ä¸ªç‰ˆæœ¬çš„é•œåƒ
          echo "Cleaning up old Docker images..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†é€»è¾‘

      - name: Cleanup old Helm releases
        run: |
          # æ¸…ç†æ—§çš„ Helm release å†å²
          helm history taishanglaojun -n taishanglaojun --max 10

  # éƒ¨ç½²é€šçŸ¥
  notify-deployment:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [determine-version, deploy-production, deploy-staging, performance-benchmark]
    if: always()
    steps:
      - name: Notify successful deployment
        if: ${{ (needs.deploy-production.result == 'success' || needs.deploy-staging.result == 'success') }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            ğŸš€ Deployment completed successfully!
            
            Environment: ${{ needs.determine-version.outputs.environment }}
            Version: ${{ needs.determine-version.outputs.version }}
            
            ğŸ”— Links:
            - Application: https://${{ needs.determine-version.outputs.environment == 'production' && 'taishanglaojun.local' || 'staging.taishanglaojun.local' }}
            - Monitoring: https://monitoring.${{ needs.determine-version.outputs.environment == 'production' && 'taishanglaojun.local' || 'staging.taishanglaojun.local' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify failed deployment
        if: ${{ needs.deploy-production.result == 'failure' || needs.deploy-staging.result == 'failure' }}
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            âŒ Deployment failed!
            
            Environment: ${{ needs.determine-version.outputs.environment }}
            Version: ${{ needs.determine-version.outputs.version }}
            
            Please check the logs and take necessary action.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create GitHub release
        if: ${{ github.ref_type == 'tag' && needs.deploy-production.result == 'success' }}
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## ğŸš€ Release ${{ github.ref_name }}
            
            ### ğŸ“‹ Changes
            - Deployed to production environment
            - Performance benchmark completed
            - Monitoring configured
            
            ### ğŸ”— Links
            - [Application](https://taishanglaojun.local)
            - [Monitoring](https://monitoring.taishanglaojun.local)
            - [Documentation](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md)
          draft: false
          prerelease: false