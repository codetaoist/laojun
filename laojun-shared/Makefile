# Makefile for laojun-shared library

.PHONY: help build test lint clean codegen check-api examples install-tools

# é»˜è®¤ç›®æ ‡
help:
	@echo "å¯ç”¨çš„å‘½ä»¤:"
	@echo "  build         - æ„å»ºæ‰€æœ‰å·¥å…·"
	@echo "  test          - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  lint          - è¿è¡Œä»£ç æ£€æŸ¥"
	@echo "  check-api     - æ£€æŸ¥APIè§„èŒƒ"
	@echo "  examples      - è¿è¡Œæ‰€æœ‰ç¤ºä¾‹"
	@echo "  codegen       - ç”Ÿæˆæ–°æ¨¡å—ä»£ç æ¨¡æ¿"
	@echo "  clean         - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  install-tools - å®‰è£…å¼€å‘å·¥å…·"

# æ„å»ºå·¥å…·
build:
	@echo "ğŸ”¨ æ„å»ºä»£ç ç”Ÿæˆå·¥å…·..."
	@go build -o bin/codegen.exe ./tools/codegen
	@echo "ğŸ”¨ æ„å»ºAPIæ£€æŸ¥å·¥å…·..."
	@go build -o bin/linter.exe ./tools/linter
	@echo "âœ… æ„å»ºå®Œæˆ"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	@go test ./...
	@echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
	@go test ./test/...
	@echo "âœ… æµ‹è¯•å®Œæˆ"

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” è¿è¡Œgolangci-lint..."
	@golangci-lint run
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

# APIè§„èŒƒæ£€æŸ¥
check-api: build
	@echo "ğŸ“‹ æ£€æŸ¥APIè§„èŒƒ..."
	@./bin/linter.exe -dir .
	@echo "âœ… APIè§„èŒƒæ£€æŸ¥å®Œæˆ"

# è¿è¡Œç¤ºä¾‹
examples:
	@echo "ğŸš€ è¿è¡Œç¼“å­˜ç¤ºä¾‹..."
	@go run examples/cache_example.go
	@echo ""
	@echo "ğŸš€ è¿è¡Œå·¥å…·ç¤ºä¾‹..."
	@go run examples/utils_example.go
	@echo ""
	@echo "ğŸš€ è¿è¡Œå¥åº·æ£€æŸ¥ç¤ºä¾‹..."
	@go run examples/health_example.go
	@echo ""
	@echo "ğŸš€ è¿è¡Œæ—¥å¿—ç¤ºä¾‹..."
	@go run examples/logger_example.go
	@echo "âœ… æ‰€æœ‰ç¤ºä¾‹è¿è¡Œå®Œæˆ"

# ç”Ÿæˆæ–°æ¨¡å—ä»£ç æ¨¡æ¿
codegen: build
	@if [ -z "$(PACKAGE)" ]; then \
		echo "âŒ è¯·æŒ‡å®šåŒ…å: make codegen PACKAGE=mypackage"; \
		exit 1; \
	fi
	@echo "ğŸ“ ç”Ÿæˆ $(PACKAGE) æ¨¡å—ä»£ç æ¨¡æ¿..."
	@./bin/codegen.exe -package $(PACKAGE) -output .
	@echo "âœ… ä»£ç æ¨¡æ¿ç”Ÿæˆå®Œæˆ"

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@rm -rf bin/
	@go clean -cache
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®‰è£…å¼€å‘å·¥å…·
install-tools:
	@echo "ğŸ“¦ å®‰è£…golangci-lint..."
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@echo "ğŸ“¦ å®‰è£…goimports..."
	@go install golang.org/x/tools/cmd/goimports@latest
	@echo "ğŸ“¦ å®‰è£…govulncheck..."
	@go install golang.org/x/vuln/cmd/govulncheck@latest
	@echo "âœ… å¼€å‘å·¥å…·å®‰è£…å®Œæˆ"

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	@go fmt ./...
	@goimports -w .
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# å®‰å…¨æ£€æŸ¥
security:
	@echo "ğŸ”’ è¿è¡Œå®‰å…¨æ£€æŸ¥..."
	@govulncheck ./...
	@echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ"

# å®Œæ•´æ£€æŸ¥ï¼ˆåŒ…å«æ‰€æœ‰æ£€æŸ¥é¡¹ï¼‰
check-all: fmt lint check-api test security
	@echo "âœ… æ‰€æœ‰æ£€æŸ¥å®Œæˆ"

# å‘å¸ƒå‰æ£€æŸ¥
pre-release: clean check-all examples
	@echo "ğŸ‰ å‘å¸ƒå‰æ£€æŸ¥å®Œæˆï¼Œå¯ä»¥å‘å¸ƒï¼"

# åˆå§‹åŒ–æ–°æ¨¡å—å¼€å‘ç¯å¢ƒ
init-module:
	@if [ -z "$(PACKAGE)" ]; then \
		echo "âŒ è¯·æŒ‡å®šåŒ…å: make init-module PACKAGE=mypackage"; \
		exit 1; \
	fi
	@echo "ğŸš€ åˆå§‹åŒ– $(PACKAGE) æ¨¡å—å¼€å‘ç¯å¢ƒ..."
	@make codegen PACKAGE=$(PACKAGE)
	@echo "ğŸ“ è¯·ç¼–è¾‘ä»¥ä¸‹æ–‡ä»¶å®Œæˆæ¨¡å—å¼€å‘:"
	@echo "  - $(PACKAGE)/interface.go"
	@echo "  - $(PACKAGE)/implementation.go"
	@echo "  - $(PACKAGE)/errors.go"
	@echo "  - $(PACKAGE)/interface_test.go"
	@echo "  - examples/$(PACKAGE)_example.go"
	@echo "âœ… æ¨¡å—åˆå§‹åŒ–å®Œæˆ"

# æ¨¡å—å¼€å‘å®Œæˆåçš„éªŒè¯
verify-module:
	@if [ -z "$(PACKAGE)" ]; then \
		echo "âŒ è¯·æŒ‡å®šåŒ…å: make verify-module PACKAGE=mypackage"; \
		exit 1; \
	fi
	@echo "ğŸ” éªŒè¯ $(PACKAGE) æ¨¡å—..."
	@go test ./$(PACKAGE)/...
	@./bin/linter.exe -dir ./$(PACKAGE)
	@go run examples/$(PACKAGE)_example.go
	@echo "âœ… $(PACKAGE) æ¨¡å—éªŒè¯å®Œæˆ"